"""Markdown generator for program information."""
from pathlib import Path
from abm_check.domain.models import Program


class MarkdownGenerator:
    """Generate Markdown files for program information."""
    
    def generate_program_md(self, program: Program) -> str:
        """
        Generate Markdown content for a program.
        
        Args:
            program: Program object
            
        Returns:
            Markdown formatted string
        """
        lines = []
        
        # Title
        lines.append(f"# {program.title}\n")
        
        # Program info
        lines.append("## ç•ªçµ„æƒ…å ±\n")
        lines.append(f"- **ç•ªçµ„ID**: {program.id}")
        lines.append(f"- **URL**: {program.url}")
        lines.append(f"- **ç·ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°**: {program.total_episodes}")
        lines.append(f"- **æœ€æ–°è©±**: ç¬¬{program.latest_episode_number}è©±")
        lines.append(f"- **å–å¾—æ—¥æ™‚**: {program.fetched_at.strftime('%Y/%m/%d %H:%M:%S')}\n")
        
        # Thumbnail
        if program.thumbnail_url:
            lines.append("## ã‚µãƒ ãƒã‚¤ãƒ«\n")
            lines.append(f"![Thumbnail]({program.thumbnail_url})\n")
        
        # Description
        if program.description:
            lines.append("## ç•ªçµ„èª¬æ˜\n")
            lines.append(f"{program.description}\n")
        
        # Episodes
        if program.episodes:
            lines.append("## ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ä¸€è¦§\n")
            
            # Separate regular episodes (< 100) and special episodes (>= 100)
            regular_episodes = [ep for ep in program.episodes if ep.number < 100]
            special_episodes = [ep for ep in program.episodes if ep.number >= 100]
            
            downloadable_count = sum(1 for ep in regular_episodes if ep.is_downloadable)
            premium_count = sum(1 for ep in regular_episodes if ep.is_premium_only)
            
            lines.append(f"- é€šå¸¸ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰: {len(regular_episodes)}è©±")
            lines.append(f"- DLå¯èƒ½: {downloadable_count}è©±")
            lines.append(f"- ãƒ—ãƒ¬ãƒŸã‚¢ãƒ é™å®š: {premium_count}è©±")
            if special_episodes:
                lines.append(f"- ç‰¹åˆ¥ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ (PVç­‰): {len(special_episodes)}è©±")
            lines.append("")
            
            # Regular episodes table
            if regular_episodes:
                lines.append("### é€šå¸¸ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰\n")
                lines.append("| DLå¯å¦ | è©±æ•° | ã‚¿ã‚¤ãƒˆãƒ« |")
                lines.append("|--------|------|----------|")
                
                for ep in sorted(regular_episodes, key=lambda x: x.number):
                    dl_status = "âœ…" if ep.is_downloadable else "ğŸ”’"
                    lines.append(f"| {dl_status} | {ep.number:02d} | {ep.title} |")
                
                lines.append("")
            
            # Special episodes table
            if special_episodes:
                lines.append("### ç‰¹åˆ¥ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ (PVç­‰)\n")
                lines.append("| DLå¯å¦ | è©±æ•° | ã‚¿ã‚¤ãƒˆãƒ« |")
                lines.append("|--------|------|----------|")
                
                for ep in sorted(special_episodes, key=lambda x: x.number):
                    dl_status = "âœ…" if ep.is_downloadable else "ğŸ”’"
                    lines.append(f"| {dl_status} | {ep.number:02d} | {ep.title} |")
                
                lines.append("")
        
        # Footer
        lines.append("---\n")
        lines.append("_Generated by abm_check_")
        
        return "\n".join(lines)
    
    def save_program_md(self, program: Program, output_dir: str = "output") -> Path:
        """
        Save program information as Markdown file.
        
        Args:
            program: Program object
            output_dir: Base directory for output
            
        Returns:
            Path to saved file
        """
        program_dir = Path(output_dir) / program.id
        program_dir.mkdir(parents=True, exist_ok=True)
        
        md_content = self.generate_program_md(program)
        
        md_file = program_dir / "program.md"
        md_file.write_text(md_content, encoding='utf-8')
        
        return md_file
