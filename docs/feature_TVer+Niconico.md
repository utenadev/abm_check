# TVer とニコニコ動画 対応機能仕様

## 概要
- `abm_check` プロジェクトに `TVer` および `ニコニコ動画` の機能を追加するための設計仕様。

## 1. 対応サイトの選択方針

### 1.1. 一択
- シリーズが特定のプラットフォームにしかない場合（例：TVer にしかないアニメ、ニコニコ動画にしかないアニメ）は、そのプラットフォームを選択。

### 1.2. 複数存在する場合
- 以下の基準で最適なプラットフォームを選択：
  - 更新速度が速い（最新話が早く配信される）。
  - 画質や動画品質が高い。
  - yt-dlp での安定性が高い（エラーが少ない）。
- **AbemaTV との関連性**: 現在の `abm_check` は AbemaTV 専用であるため、TVer やニコニコ動画が AbemaTV と同等または上回る品質を提供する場合に追加対応を検討。

## 2. コマンド設計

### 2.1. 新規コマンドの追加
- `abm_check add-tver`: TVer 用の追加コマンド。
- `abm_check add-nico`: ニコニコ動画用の追加コマンド。
- `abm_check update-all`: 全プラットフォーム（AbemaTV、TVer、ニコニコ動画）の番組情報を更新。

### 2.2. 定義ファイルの分割
- 各プラットフォームごとに定義ファイルを分ける（例：`programs_tver.yaml`, `programs_nico.yaml`, `programs_abema.yaml`）。
  - 各ファイルは `programs.yaml` と同様の構造を持つが、プラットフォーム固有のデータを保持。

## 3. 定時実行と download.txt 出力

### 3.1. 定時実行
- 各プラットフォームの更新情報を定期的にチェックし、`download_urls.txt` に出力。
- 更新処理は `abm_check update-all` で実行し、新規エピソードや無料化されたエピソードを検出。

### 3.2. download.txt の内容
- `download_urls.txt` には、エピソードごとのダウンロードURLを記載。

## 4. 番組検索と登録機能

### 4.1. 番組名（一部）での検索
- 各プラットフォームで指定された番組名に一致するシリーズを検索（例：`abm_check search "機械じかけのマリィ"`）。

### 4.2. 検索結果から登録
- 検索結果を表示し、ユーザーが選択したシリーズを定義ファイルに追加。
  - `abm_check add-tver-by-name "機械じかけのマリィ"` のようなコマンドも検討。

## 5. 実装方針

### 5.1. データモデルの共通化
- `Program` と `Episode` モデルを、各プラットフォームに対応するように拡張。

### 5.2. fetcher の拡張
- `fetcher.py` で TVer とニコニコ動画の情報を取得するメソッドを追加。

### 5.3. CLI コマンドの追加
- `cli/main.py` に TVer とニコニコ動画用のサブコマンドを追加。

### 5.4. テストの追加
- 各プラットフォームに対応するテストケースを `tests/` に追加。

## 6. 注意点

- ニコニコ動画のチャンネルページは yt-dlp で取得できないため、`fetch` を使用して HTML 解析が必要。
- プラットフォームごとに API や URL 構造が異なるため、柔軟なパーサー構造が必要。
- サイト構造変更に備えて、定期的な検証と更新が必要。