# TVer とニコニコ動画対応に関する検討事項

## 概要
- `abm_check` プロジェクトを `TVer` および `ニコニコ動画` に対応させるための調査と検討事項をまとめたドキュメント。

## TVer 対応

### 1. シリーズ → エピソード構造
- **シリーズ**: `https://tver.jp/series/{series_id}`
- **エピソード**: `https://tver.jp/episodes/{episode_id}`

### 2. yt-dlp での情報取得
- `yt-dlp --dump-json` で、シリーズとエピソードの情報を取得可能。
- シリーズページからエピソード一覧を取得し、各エピソードのメタデータを処理。

### 3. データモデルの拡張
- `Program` モデルに TVer 向けの情報を追加（例：`tver_series_id`, `is_tver`）。
- `Episode` モデルに TVer 向けの情報を追加（例：`tver_episode_id`, `is_downloadable`）。

### 4. シーズン構成の処理
- TVer は AbemaTV と同様に、シリーズ単位でシーズン構成が存在する場合がある。
- `total_episodes` や `latest_episode_number` を TVer のメタデータから取得・更新。

### 5. エピソードの無料配信判定
- yt-dlp の `availability` フィールドや他のメタデータから、無料配信かどうかを判定。

## ニコニコ動画対応

### 1. シリーズ → エピソード構造
- **チャンネル**: `https://ch.nicovideo.jp/{channel_name}` または `https://ch.nicovideo.jp/ch{number}`
- **エピソード**: `https://www.nicovideo.jp/watch/so{number}`

### 2. yt-dlp での情報取得
- **チャンネルページ**: yt-dlp が対応していないため、`fetch` での解析が必要。
- **エピソードページ**: `https://www.nicovideo.jp/watch/so{number}` は yt-dlp で情報取得可能。

### 3. チャンネルページの解析（fetch 使用）
- `fetch` を使用してチャンネルページからエピソード一覧を抽出。
- エピソードの `so` 番号とタイトルを取得。

### 4. データモデルの拡張
- `Program` モデルにニコニコ動画向けの情報を追加（例：`nico_channel_id`, `is_nico`）。
- `Episode` モデルにニコニコ動画向けの情報を追加（例：`nico_watch_id`, `is_downloadable`）。

### 5. シーズン構成の扱い
- ニコニコ動画はシーズン概念が明確でない場合が多い。
- 連続した `so` 番号を同一シリーズとして扱うことを検討。

### 6. 更新・差分検出機能の拡張
- チャンネルページを定期的にチェックし、新規エピソード（`so` 番号）を検出。
- yt-dlp でエピソード情報取得後、最新話数や全話数を更新。

## 共通の実装方針

### 1. 抽象化と共通化
- `fetcher.py` 内で、TVer とニコニコ動画の情報を取得するための共通インターフェースを定義。
- サイトごとの処理を別クラスとして分離し、共通処理と差分を明確にする。

### 2. CLI コマンドの拡張
- `abm_check add-tver` や `abm_check add-nico` のような、新規プラットフォーム向けコマンドを追加。
- 現在の `add` コマンドを拡張し、URL から自動的にサイトを判定して処理する方法も検討。

### 3. テストと検証
- 各サイト向けのテストケースを `tests/` に追加。
- yt-dlp の返す情報構造の違いに応じたパーサーを検証。

## 注意点
- TVer は公式番組限定のため、番組情報の取得漏れに注意。
- ニコニコ動画は公式とユーザー投稿の混在に注意し、アニメ公式チャンネルの特定が必要。
- サイト構造変更に備えて、柔軟なパーサー構造を維持。
- チャンネルページがJavaScriptで動的に生成される場合、`fetch` だけでは不十分な可能性があるため、必要に応じてブラウザ自動化ツール（Selenium等）の検討も必要。