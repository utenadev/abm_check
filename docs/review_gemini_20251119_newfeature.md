# TVer・ニコニコ動画対応機能追加に関するリスクレビュー

**レビュー実施日:** 2025年11月19日
**レビュー担当:** Gemini

## はじめに

ご提示いただいた機能追加の計画（`consideration_TVer_niconico.md`, `feature_TVer+Niconico.md`）は非常によく整理されています。しかし、実際の開発・運用では計画通りに進まないことが多々あります。

本レビューでは、より堅牢なシステムを構築するため、特に外部サービスへの依存度が高い今回の機能追加における潜在的なリスクを深掘りし、厳しい視点での指摘と対策を提案します。

---

### 1. 技術的負債と不安定性に関するリスク

**指摘1: スクレイピングへの過度な依存は「時限爆弾」である**
ニコニコ動画のチャンネルページを `fetch` でHTML解析する方針は、最も脆弱な部分です。相手のサイト構造が少しでも変われば、機能は即座に停止します。これは単なるバグではなく、**定期的なメンテナンスが不可避な技術的負債**を抱え込むことを意味します。

-   **リスク:**
    -   サイト側のUI変更、クラス名やIDの変更で、予告なく情報が取得できなくなる。
    -   動的なコンテンツ（JavaScriptによる描画）が増えた場合、`fetch` だけでは対応できず、Seleniumのような重量級のライブラリ追加が必須となり、環境構築や実行速度に悪影響を及ぼす。
-   **対策の提案:**
    -   HTML構造の変更を自動検知するテスト（スナップショットテストなど）を導入し、CIで定期実行する仕組みを構築すべきです。
    -   エラー発生時に、開発者へ即座に通知（Slack, Email等）が飛ぶアラート機構を設けるべきです。

**指摘2: `yt-dlp` は万能ではない**
`yt-dlp` への依存は強力ですが、これもまた外部要因です。TVerやニコニコ動画が仕様を変更した際、`yt-dlp` が対応するまでにはタイムラグが発生します。

-   **リスク:**
    -   `yt-dlp` のアップデートが追いつかず、長期間にわたり情報取得が失敗する可能性がある。
    -   プラットフォーム側の対策（アンチボットなど）により、`yt-dlp` からのアクセス自体がブロックされるようになる。
-   **対策の提案:**
    -   各Fetcherに「最終成功日時」と「ステータス」を持たせ、特定のプラットフォームが長時間失敗していることをユーザーが認識できる仕組みが必要です。
    -   `yt-dlp` 以外の代替取得手段（非公式APIなど）がないか、バックアッププランを調査しておくべきです。

### 2. 設計の拡張性に関する懸念

**指摘3: データモデルと設定ファイルの設計が硬直化する危険性**
`is_tver`, `is_nico` のような真偽値フラグや `tver_series_id` のような個別IDを `Program` モデルに追加していく方法は、**3つ目、4つ目のプラットフォームが登場した時点で破綻します**。コードは `if/elif` の分岐だらけになり、可読性とメンテナンス性が著しく低下します。

-   **リスク:**
    -   新しいプラットフォームを追加するたびに、コアとなる `Program` モデルの変更が必要になり、影響範囲が広がる。
    -   設定ファイル (`programs_tver.yaml` 等) を分割する案は、`update-all` のような横断的な処理で複数のファイルを読み書きする必要があり、処理が煩雑化・非効率化する。
-   **対策の提案:**
    -   **ストラテジーパターンの導入:** プラットフォームごとの処理（ID形式、URL生成、情報取得方法）をカプセル化した `PlatformStrategy` のようなクラスを作成し、`Program` はそれを保持する形に設計変更すべきです。これにより、`Program` モデル自体は変更せず、新しいプラットフォームのクラスを追加するだけで対応できます。
    -   **設定ファイルの再検討:** 1つの `programs.yaml` 内で、各番組に `platform: tver` のような属性を持たせる方が、管理がシンプルです。ファイルの分割は、本当にメリットがデメリットを上回るか再考すべきです。

### 3. 機能の実現性とUXの課題

**指摘4: 「便利な機能」が実装の沼になる**
「番組名（一部）での検索」や「最適なプラットフォームの自動選択」は聞こえは良いですが、実現には多大な困難が伴います。

-   **リスク:**
    -   **検索機能:** 公式の検索APIが提供されていない場合、サイト内検索の結果ページをスクレイピングする必要があり、実装が非常に複雑で不安定になります。
    -   **自動選択:** 「更新速度」「画質」をどうやってプログラムが定量的に比較・判断するのか、具体的なロジックが不明確です。このロジックはユーザーの期待とずれる可能性が高く、クレームの原因になり得ます。
-   **対策の提案:**
    -   **MVP（Minimum Viable Product）の再定義:** まずは「**ユーザーがURLを直接指定して登録する**」というコア機能に絞ってリリースし、検索機能は将来の課題と位置づけるべきです。
    -   自動選択は廃止し、複数のプラットフォームで番組が見つかった場合は、ユーザーに選択させるインターフェースを提供する方が現実的です。

### 4. 運用・保守コストの増大

**指摘5: テストとデバッグが困難を極める**
外部サイトに依存する機能のテストは、本質的に不安定です。

-   **リスク:**
    -   CI/CDの実行が、相手サイトの状態によって失敗し、開発プロセスが頻繁にブロックされる。
    -   実際のレスポンスを保存したモック（VCRテストなど）は、サイト仕様の変更に追従して更新し続ける必要があり、保守コストが非常に高い。
-   **対策の提案:**
    -   外部APIとの「契約」をテストする、**スキーマ駆動の契約テスト**の導入を検討すべきです。レスポンスのJSON構造が期待通りかを検証することで、UI変更のような些細な変更に影響されない、より堅牢なテストを構築できます。

---

## まとめと提言

計画は詳細ですが、**外部サービスへの依存に伴う「不安定性」**に対する防御策が不足しています。このまま進めると、リリース直後から頻繁な障害対応に追われる未来が予見されます。

**提言:**

1.  **スコープの縮小:** 最初のリリースでは、**URL指定によるTVer/ニコニコ動画番組の追加・更新機能**に限定する。検索や自動選択などの高度な機能は一旦凍結する。
2.  **設計の見直し:** プラットフォーム追加に強いアーキテクチャ（**ストラテジーパターン**など）へリファクタリングする。これは将来の拡張性を確保するための先行投資です。
3.  **安定性の強化:** HTML構造の変更を検知する**自動テストとアラート機構**を必須要件として実装計画に組み込む。
4.  **法的・倫理的リスクの確認:** スクレイピングが各サービスの利用規約に抵触しないか確認し、サーバーに過度な負荷をかけないよう、アクセス間隔を空ける（例: 1リクエストごとに数秒待つ）などの配慮を実装に盛り込む。
