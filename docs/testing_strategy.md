# テスト戦略

このドキュメントは、`abm-check` プロジェクトのテスト戦略について、テストの種類、構造、ガイドライン、およびカバレッジ目標を含めて概説します。

## 1. テストの基本方針

私たちの目標は、堅牢で信頼性が高く、保守しやすいテストスイートを維持することです。テストは以下の条件を満たすべきです。
- **明確であること**: 何がテストされているのかを理解しやすいこと。
- **信頼できること**: 基盤となるコードが正しい場合は常に合格し、そうでない場合は失敗すること。
- **独立していること**: テストが他のテストの状態に依存しないこと。

## 2. テストの種類

テストスイートは、別々のディレクトリに配置された3つの主要なカテゴリに分けられます。

### 2.1 単体テスト (`tests/unit`)

- **目的**: 個々のコンポーネント（クラス、関数）を単独でテストすること。
- **実装**: 他のクラスや外部サービス（ネットワーク、ファイルシステム）などの依存関係は、`unittest.mock` を使用してモック化する必要があります。これにより、テストが高速で集中的になります。

### 2.2 統合テスト (`tests/integration`)

- **目的**: 2つ以上のコンポーネント間の相互作用をテストすること。
- **実装**: これらのテストは、アプリケーションの異なる部分が期待どおりに連携することを確認します。例えば、`ProgramUpdater` から `ProgramStorage` および `DownloadListGenerator` へのフローをテストします。モック化は最小限に抑えられ、通常はネットワークリクエストのような外部境界のみが対象となります。

### 2.3 エンドツーエンド (E2E) テスト (`tests/e2e`)

- **目的**: ユーザーの視点からアプリケーションをテストすること。
- **実装**: これらのテストは、CLIコマンドの実行などのユーザーアクションをシミュレートし、出力と副作用（例：ファイルの作成）を確認します。開発環境に干渉しないように、隔離されたファイルシステムで実行されます。

## 3. テスト構造

### 3.1 ディレクトリレイアウト

- `tests/unit/`: 単体テスト用。
- `tests/integration/`: 統合テスト用。
- `tests/e2e/`: エンドツーエンドテスト用。
- `tests/fixtures/`: APIからのJSONレスポンスなどの静的テストデータ用。

### 3.2 共通フィクスチャ (`tests/conftest.py`)

- コードの重複を避けるため、共通の `pytest` フィクスチャは `tests/conftest.py` で定義されます。
- これには、`Program` や `Episode` (`create_program`、`create_episode`) のような共通データモデルを作成するためのファクトリフィクスチャが含まれます。

### 3.3 テストデータ

- **動的データ**: ほとんどのテストでは、`conftest.py` の共通フィクスチャを使用してデータを動的に生成する必要があります。これにより、テストがより読みやすく、自己完結型になります。
- **静的データ**: 実際のAPIレスポンスや大規模で複雑なデータ構造は、`tests/fixtures/` にJSONファイルとして保存し、テストでロードする必要があります。

## 4. テストの記述

### 4.1 命名規則

テスト関数は、テスト内容を反映するように記述的に命名する必要があります。
`test_<モジュールまたはクラス名>_<関数名>_<シナリオ>`

例: `test_updater_update_program_new_episode`

### 4.2 `pytest.mark.parametrize` の使用

さまざまな入力とエッジケースを持つ関数をテストするには、`@pytest.mark.parametrize` を使用してテストコードをDRY（Don't Repeat Yourself）に保ちます。これは、検証ロジックやさまざまなデータ条件をテストする場合に特に役立ちます。

```python
@pytest.mark.parametrize(
    "invalid_id",
    ["../../etc/passwd", "invalid!id", "some/path"]
)
def test_add_command_invalid_id(runner, invalid_id):
    # ...
```

### 4.3 アサーション

- シンプルで明確な `assert` ステートメントを使用します。
- 各テストは、理想的には1つの論理的な結果をテストすべきです。単一のテストで無関係なアサーションを多数持つことは避けてください。

## 5. テストカバレッジ

### 5.1 目標

テストカバレッジの目標は **90%** です。これにより、コードベースのほとんどがリグレッションから保護されます。

### 5.2 実行方法

プロジェクトルートから以下のコマンドを実行すると、すべてのテストが実行され、カバレッジレポートが生成されます。

```bash
python -m pytest --cov
```